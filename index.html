<head>
	<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

	<script>if (window.module) module = window.module;</script>
</head>

<body style="margin: 0px !important; background-color: black; color: white;">
	<link rel="stylesheet" type="text/css" href="./index.css">

	<div id="toolbar">
		<div id="back-button" class="toolbar-button"></div>
		<div id="reload-button" class="toolbar-button"></div>
		<div id="forward-button" class="toolbar-button"></div>
	</div>

	<div id="loading-text" style="z-index: 0; z-index: 0; position: absolute; top: 50%; left: 50%; font-size: 32px; transform: translate(-50%, -50%); opacity: 1;">
		Loading...
	</div>

	<webview id="webview" src="https://music.youtube.com/" httpreferrer="https://music.youtube.com/" preload="./preload.js" nodeintegration disablewebsecurity allowpopups></webview>
	<script>
		const {
			ipcRenderer,
			clipboard,
			remote
		} = require('electron');

		const webview = $("webview");
		const loadingText = $("#loading-text");
		const toolbar = $("#toolbar");

		// Set up the toolbar buttons.
		var backButton = $("#back-button");
		backButton.on("click", () => {
			window.history.back();
		});
		var reloadButton = $("#reload-button");
		reloadButton.on("click", () => {
			window.location.reload();
		});
		var forwardButton = $("#forward-button");
		forwardButton.on("click", () => {
			window.history.forward();
		});

		// Change the height of the webview when the toolbar is hovered.
		openToolbar();
		setTimeout(() => {
			closeToolbar();
		}, 5000);
		toolbar.on("mouseover", () => {
			openToolbar();
		});
		toolbar.on("mouseout", () => {
			closeToolbar();
		});

		function openToolbar() {
			toolbar.removeClass("toolbar-closed");
			toolbar.addClass("toolbar-open");

			webview.removeClass("toolbar-closed");
			webview.addClass("toolbar-open");
		}

		function closeToolbar() {
			toolbar.removeClass("toolbar-open");
			toolbar.addClass("toolbar-closed");

			webview.removeClass("toolbar-open");
			webview.addClass("toolbar-closed");
		}


		// Add the link handling for the main process to use.
		function pasteLink() {
			// Parse the YouTube link and handle how to navigate to it.
			var clipboardText = clipboard.readText("clipboard");

			console.log(clipboardText);

			// Save the original clipboard text.
			var originalClipboardText = clipboardText;

			// Check if the link is a normal YouTube link.
			var regExp = /.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/;
			var match1 = clipboardText.match(regExp);

			// Attempt to change the link into a YouTube Music link.
			clipboardText = clipboardText.replace("http://", "https://").replace("youtu.be", "youtube.com").replace("youtube.com", "music.youtube.com").replace("www.", "");

			// Make sure that the link has "watch?v=" at the end of it.
			if (clipboardText.indexOf("music.youtube.com/watch?v=") < 0) {
				clipboardText = clipboardText.replace("music.youtube.com/", "music.youtube.com/watch?v=");
			}

			// Run a second match on the YouTube link to make sure it is correct.
			regExp = /.*(?:https:\/\/music.youtube.com\/watch\?v=)([^#\&\?]*).*/;
			var tmpMatch = clipboardText.match(regExp);
			var match2 = tmpMatch && tmpMatch[1].length == 11;

			console.warn("Possible link: " + originalClipboardText + "\n\n" + "Possibly formatted link: " + clipboardText);

			if (originalClipboardText.indexOf("https://music.youtube.com") == 0) {
				// It's a YouTube Music link.
				// It was right all along.

				console.warn("Easy YouTube Music link.");
				webview.attr("src", originalClipboardText);
			} else if (match1 && match2) {
				// It wasn't a YouTube Music link, but it was turned into one.
				// So it uses the now morphed link with all of the extra YouTube URL attributes.

				console.warn("Harder YouTube link.");
				webview.attr("src", clipboardText);
			} else if (youtubeID(clipboardText)) {
				// It isn't a YouTube Music link, and it couldn't be turned into one.
				// It has a YouTube ID in it, so it uses that.

				console.warn("Hardest YouTube link.");
				webview.attr("src", "https://music.youtube.com/watch?v=" + youtubeID(clipboardText));
			} else {
				console.error("No link found.");
			}
		}

		function youtubeID(url) {
			var regExp = /.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
			var match = url.match(regExp);
			return (match && match[1].length == 11) ? match[1] : false;
		}




		// Handle loading animations.
		webview.on("dom-ready", () => {});
		// Mirror all console messages to the main page's console.
		webview.on('console-message', (e) => {
			console.log("Webview:\n" + e.message);
		});

		var firstLoad = true;

		const loadStart = () => {
			if (firstLoad) {
				firstLoad = false;

				webview.attr("style", "opacity: 0;");
				loadingText.attr("style", "z-index: 0; z-index: 0; position: absolute; top: 50%; left: 50%; font-size: 32px; transform: translate(-50%, -50%); opacity: 1;");
			} else {
				webview.attr("style", "transition-duration: 1s; opacity: 1;");
				loadingText.attr("style", "z-index: 0; position: absolute; top: 50%; left: 50%; font-size: 32px; transform: translate(-50%, -50%); transition-duration: 1s; opacity: 0;");
				setTimeout(() => {
					webview.attr("style", "transition-duration: 1s; opacity: 0;");
					loadingText.attr("style", "z-index: 0; transition-duration: 1s;z-index: 0; position: absolute; top: 50%; left: 50%; font-size: 32px; transform: translate(-50%, -50%); opacity: 1;");
				}, 100);
			}
		}

		const loadStop = () => {
			webview.attr("style", "transition-duration: 1s; opacity: 0;");
			loadingText.attr("style", "z-index: 0; position: absolute; top: 50%; left: 50%; font-size: 32px; transform: translate(-50%, -50%); transition-duration: 1s; opacity: 1;");
			setTimeout(() => {
				webview.attr("style", "transition-duration: 1s; opacity: 1;");
				loadingText.attr("style", "z-index: 0; transition-duration: 1s;z-index: 0; position: absolute; top: 50%; left: 50%; font-size: 32px; transform: translate(-50%, -50%); opacity: 0;");
			}, 100);
		}

		webview.on("did-start-loading", loadStart);
		webview.on("did-stop-loading", loadStop);


		webview.on("ipc-message", function(e) {
			if (e.channel === "window-data") {
				var webviewDOM = $(document.createElement("html"));
				webviewDOM.html(e.args[0].html);

				var selectedElement = webviewDOM[0].querySelector(".title.ytmusic-player-bar");
				if (selectedElement) {
					songName = selectedElement.textContent;
				}

				selectedElement = webviewDOM[0].querySelector(".byline.ytmusic-player-bar");
				if (selectedElement) {
					if (selectedElement.textContent != "Video will play after ad") {
						songAuthor = selectedElement.textContent;
					}
				}

				//time-info style-scope ytmusic-player-bar
				selectedElement = webviewDOM[0].querySelector(".time-info.ytmusic-player-bar");
				if (selectedElement) {
					var currentTime = selectedElement.textContent.split("/")[0].trim();
					var totalTime = selectedElement.textContent.split("/")[1].trim();

					try {
						var currentTimeMS = (parseInt(currentTime.split(":")[1]) * 1000) + (parseInt(currentTime.split(":")[0]) * 60000);
						var totalTimeMS = (parseInt(totalTime.split(":")[1]) * 1000) + (parseInt(totalTime.split(":")[0]) * 60000);

						songStartedTime = Date.now();
						songEndsTime = Date.now() + totalTimeMS - currentTimeMS;
					} catch (e) {}
				}

				selectedElement = webviewDOM.querySelector("#play-pause-button");
				if (selectedElement) {
					songPaused = (selectedElement.title == "Play" ? true : false);
					if (songName.trim() == "" || songAuthor.trim() == "") {
						songPaused = true;
					}
					if (!songPaused) {
						sentPaused = false;
					}
				}
			}
		});


		var songAuthor = "";
		var songName = "";

		var songStartedTime = Date.now();
		var songEndsTime = Date.now();

		var songPaused = true;

		var sentPaused = false;

		function sendRPData() {
			if (songPaused && !sentPaused) {
				sentPaused = true;
				ipcRenderer.send("rich-presence-data", {
					"songName": songName,
					"songAuthor": songAuthor,
					"songStartedTime": songStartedTime,
					"songEndsTime": songEndsTime,
					"songPaused": songPaused
				});
			} else if (!songPaused) {
				ipcRenderer.send("rich-presence-data", {
					"songName": songName,
					"songAuthor": songAuthor,
					"songStartedTime": songStartedTime,
					"songEndsTime": songEndsTime,
					"songPaused": songPaused
				});
			}
		}

		sendRPData();

		setInterval(() => {
			sendRPData();
		}, 15e3);
	</script>
</body>
